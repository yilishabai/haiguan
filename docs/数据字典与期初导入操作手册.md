# 项目数据字典与期初数据导入操作手册

本手册包含：

- 现有所有数据表结构（字段、类型、用途）
- 各表涉及的“状态字段”及可选值
- 清空并导入期初数据的两种操作方法（快速重置与精准清空）
- 企业数据 Excel 导入说明

> 当前项目前端内嵌的数据库基于 `sql.js`，使用浏览器 `localStorage` 键 `sqlite_db_v1` 持久化。初始化阶段会执行建表、种子数据填充与必要迁移。

---

## 数据字典

以下为 `src/lib/sqlite.ts` 中定义/迁移的主要数据表。字段类型为 SQLite 类型。

### system_metrics
- 用途：系统指标缓存
- 字段：
  - `key TEXT PRIMARY KEY`
  - `value REAL`

### orders
- 用途：订单主表
- 字段：
  - `id TEXT PRIMARY KEY`
  - `order_number TEXT`
  - `enterprise TEXT`
  - `category TEXT`
  - `status TEXT`（状态字段）
  - `amount REAL`
  - `currency TEXT`
  - `created_at TEXT`
  - `updated_at TEXT`
  - 迁移新增：`incoterms TEXT`, `trade_terms TEXT`, `route TEXT`, `pi_no TEXT`, `ci_no TEXT`, `pl_no TEXT`, `forwarder_id TEXT`, `broker_id TEXT`, `carrier_id TEXT`, `supplier_id TEXT`, `buyer_id TEXT`
- 状态取值：`pending`、`processing`、`customs`、`shipping`、`completed`、`blocked`

### settlements
- 用途：结算记录
- 字段：
  - `id TEXT PRIMARY KEY`
  - `order_id TEXT`
  - `status TEXT`（状态字段）
  - `settlement_time REAL`
  - `risk_level TEXT`
  - 迁移新增：`payment_method TEXT`
- 状态取值：`pending`、`processing`、`completed`、`failed`

### customs_clearances
- 用途：通关（申报）记录
- 字段：
  - `id TEXT PRIMARY KEY`
  - `declaration_no TEXT`
  - `product TEXT`
  - `enterprise TEXT`
  - `status TEXT`（状态字段）
  - `clearance_time REAL`
  - `compliance REAL`
  - `risk_score REAL`
  - `order_id TEXT`
- 状态取值：`declared`、`cleared`、`held`、`inspecting`

### logistics
- 用途：物流节点记录
- 字段：
  - `id TEXT PRIMARY KEY`
  - `tracking_no TEXT`
  - `origin TEXT`
  - `destination TEXT`
  - `status TEXT`（状态字段）
  - `estimated_time REAL`
  - `actual_time REAL`
  - `efficiency REAL`
  - `order_id TEXT`
  - 迁移新增：`mode TEXT`, `carrier TEXT`, `etd TEXT`, `eta TEXT`, `atd TEXT`, `ata TEXT`, `bl_no TEXT`, `awb_no TEXT`, `is_fcl INTEGER`, `freight_cost REAL`, `insurance_cost REAL`
- 状态取值：`pickup`、`transit`、`customs`、`delivery`、`completed`

### payments
- 用途：支付渠道指标
- 字段：`method TEXT PRIMARY KEY`, `volume INTEGER`, `amount REAL`, `success_rate REAL`, `avg_time REAL`

### inventory
- 用途：库存指标
- 字段：`name TEXT PRIMARY KEY`, `current INTEGER`, `target INTEGER`, `production INTEGER`, `sales INTEGER`, `efficiency REAL`

### algorithms
- 用途：算法库
- 字段：
  - `id TEXT PRIMARY KEY`
  - `name TEXT`
  - `category TEXT`
  - `version TEXT`
  - `status TEXT`（状态字段）
  - `accuracy REAL`
  - `performance REAL`
  - `usage INTEGER`
  - `description TEXT`
  - `features TEXT`
  - `lastUpdated TEXT`
  - `author TEXT`
  - `code TEXT`
- 状态取值：`active`、`testing`、`development`

### business_models
- 用途：业务模型库
- 字段：
  - `id TEXT PRIMARY KEY`
  - `name TEXT`
  - `category TEXT`
  - `version TEXT`
  - `status TEXT`（状态字段）
  - `enterprises INTEGER`
  - `orders INTEGER`
  - `description TEXT`
  - `scenarios TEXT`
  - `compliance TEXT`
  - `successRate REAL`
  - `lastUpdated TEXT`
  - `maintainer TEXT`
  - 迁移新增：`chapters TEXT`
- 状态取值：常用 `active`

### timeline_events
- 用途：时间线事件
- 字段：`id TEXT PRIMARY KEY`, `date TEXT`, `time TEXT`, `title TEXT`, `location TEXT`, `icon TEXT`, `status TEXT`

### audit_logs
- 用途：系统审计日志
- 字段：`id INTEGER PRIMARY KEY AUTOINCREMENT`, `message TEXT`, `created_at TEXT`

### applications
- 用途：应用/申请记录
- 字段：`id TEXT PRIMARY KEY`, `applicationNo TEXT`, `enterprise TEXT`, `category TEXT`, `type TEXT`, `status TEXT`, `submitDate TEXT`, `expectedDate TEXT`, `priority TEXT`, `compliance REAL`, `riskScore REAL`, `reviewer TEXT`, `progress REAL`
- 状态取值：`submitted`、`under_review`、`field_test`、`approved`、`rejected`、`pending_docs`

### acceptance_criteria
- 用途：验收准则
- 字段：`id TEXT PRIMARY KEY`, `name TEXT`, `category TEXT`, `status TEXT`, `progress REAL`, `deadline TEXT`, `assignee TEXT`, `compliance REAL`
- 状态取值：`pending`、`in_progress`、`completed`、`failed`

### review_workflows
- 用途：评审流程节点
- 字段：`id TEXT PRIMARY KEY`, `applicationId TEXT`, `stage TEXT`, `status TEXT`, `reviewer TEXT`, `startDate TEXT`, `endDate TEXT`, `comments TEXT`
- 状态取值：`pending`、`in_progress`、`completed`

### trade_stream
- 用途：交易流水（监控用）
- 字段：`id TEXT PRIMARY KEY`, `order_id TEXT`, `from_city TEXT`, `to_city TEXT`, `amount REAL`, `ts TEXT`

### ports_congestion
- 用途：港口拥堵指数
- 字段：`port TEXT PRIMARY KEY`, `idx REAL`, `updated_at TEXT`

### customs_headers
- 用途：申报单头表
- 字段：`id TEXT PRIMARY KEY`, `declaration_no TEXT UNIQUE`, `enterprise TEXT`, `consignor TEXT`, `consignee TEXT`, `port_code TEXT`, `trade_mode TEXT`, `currency TEXT`, `total_value REAL`, `gross_weight REAL`, `net_weight REAL`, `packages INTEGER`, `country_origin TEXT`, `country_dest TEXT`, `status TEXT`, `declare_date TEXT`, `order_id TEXT`, `updated_at TEXT`
- 状态取值：同申报流程（`declared`、`cleared`、`held`、`inspecting`）

### customs_items
- 用途：申报单货项表
- 字段：`id TEXT PRIMARY KEY`, `header_id TEXT`, `line_no INTEGER`, `hs_code TEXT`, `name TEXT`, `spec TEXT`, `unit TEXT`, `qty REAL`, `unit_price REAL`, `amount REAL`, `origin_country TEXT`, `tax_rate REAL`, `tariff REAL`, `excise REAL`, `vat REAL`

### participant_roles
- 用途：企业参与角色
- 字段：`enterprise_id TEXT`, `role TEXT`, `PRIMARY KEY(enterprise_id, role)`
- 角色取值：`supplier`、`buyer`、`forwarder`、`3pl`、`broker`、`carrier`

### exchange_rates
- 用途：汇率表
- 字段：`base TEXT`, `quote TEXT`, `rate REAL`, `updated_at TEXT`, `PRIMARY KEY(base, quote)`

### ports
- 用途：港口
- 字段：`code TEXT PRIMARY KEY`, `name TEXT`, `country TEXT`

### countries
- 用途：国家
- 字段：`code TEXT PRIMARY KEY`, `name TEXT`

### units
- 用途：计量单位
- 字段：`code TEXT PRIMARY KEY`, `name TEXT`, `factor REAL`

### carriers
- 用途：承运人
- 字段：`id TEXT PRIMARY KEY`, `name TEXT`, `type TEXT`
- 类型取值：`ocean`、`air`

### incoterms
- 用途：国际贸易术语
- 字段：`code TEXT PRIMARY KEY`, `name TEXT`, `description TEXT`

### documents
- 用途：单证（PO/PI/CI/PL/BL/AWB等）
- 字段：`id TEXT PRIMARY KEY`, `order_id TEXT`, `type TEXT`, `number TEXT`, `issued_at TEXT`, `url TEXT`, `extra TEXT`

### track_events
- 用途：物流轨迹事件
- 字段：`id TEXT PRIMARY KEY`, `logistics_id TEXT`, `event TEXT`, `status TEXT`, `ts TEXT`
- 状态取值：常用 `ok`

### enterprises
- 用途：备案企业
- 字段：`id TEXT PRIMARY KEY`, `reg_no TEXT`, `name TEXT`, `type TEXT`, `category TEXT`, `region TEXT`, `status TEXT`, `compliance REAL`, `service_eligible INTEGER`, `active_orders INTEGER`, `last_active TEXT`
- 状态取值：`active`、`inactive`、`blocked`

### settings
- 用途：通用设置
- 字段：`key TEXT PRIMARY KEY`, `value TEXT`

### algo_test_logs
- 用途：算法测试日志
- 字段：`id INTEGER PRIMARY KEY AUTOINCREMENT`, `algo_id TEXT`, `ts TEXT`, `input TEXT`, `status TEXT`, `duration_ms INTEGER`
- 状态取值：自由文本（建议：`success`/`error`）

### case_traces
- 用途：全流程案例追踪
- 字段：
  - `id TEXT PRIMARY KEY`
  - `ts TEXT`
  - `order_id TEXT`
  - `input_snapshot TEXT`
  - `model_name TEXT`
  - `output_result TEXT`
  - `business_outcome TEXT`（状态/结果字段）
  - `business_impact_value REAL`
  - `confidence REAL`
  - `latency_ms INTEGER`
  - `hs_code TEXT`
  - `hs_chapter TEXT`
  - `compliance_score REAL`
  - `customs_status TEXT`（状态字段）
  - `logistics_status TEXT`（状态字段）
  - `settlement_status TEXT`（状态字段）
- 结果取值：`Cleared`、`Risk Review`
- 各状态取值：同上对应模块（通关/物流/结算）

### algorithm_bindings
- 用途：订单与算法绑定
- 字段：`id INTEGER PRIMARY KEY AUTOINCREMENT`, `order_id TEXT`, `algorithm_id TEXT`, `created_at TEXT`

### algorithm_flows
- 用途：算法流程定义
- 字段：`algorithm_id TEXT PRIMARY KEY`, `name TEXT`, `blocks TEXT`, `edges TEXT`, `updated_at TEXT`

---

## 状态字段中文对照

为统一展示，前端使用如下中文映射（示例）：

- `pending` → 等待中
- `in_progress` / `processing` → 进行中
- `completed` → 已完成
- `rejected` / `failed` → 已拒绝
- `declared` → 已申报
- `cleared` → 已通关
- `held` / `inspecting` → 查验中
- `customs` → 报关中
- `pickup` → 揽收
- `transit` → 运输中
- `delivery` → 派送中
- 案例业务结果：
  - 包含 `auto-pass/cleared/release` → 放行
  - 包含 `manual-review/risk/review/flag` → 风险复核
  - 包含 `blocked/reject/failed` → 阻断
  - 包含 `error` → 错误

---

## 清空并导入期初数据

### 方法一：快速重置（推荐）
此方法会清空浏览器持久化的本地数据库，并在刷新后自动执行建表与种子数据导入。

1) 打开浏览器控制台（DevTools），在 `Console` 执行：

```js
localStorage.removeItem('sqlite_db_v1');
location.reload();
```

2) 页面刷新后，前端会自动：
- 创建所有表结构（含迁移）
- 通过内置 `seed()` 写入期初种子数据（订单、申报、物流、结算、支付、库存、算法、业务模型、企业等）
- 执行 `syncFromBackendInto`（如后端可用）同步部分真实数据（订单、申报）

### 方法二：精准清空（保留结构）
此方法仅删除各表数据，不影响表结构。随后可继续执行“快速重置”导入期初数据，或通过各自导入通道导入业务数据。

在控制台执行（示例）：

```js
// 动态导入前端数据库工具
const m = await import('/src/lib/sqlite.ts');

// 逐表清空（仅示例，按需增减）
await m.exec('DELETE FROM orders');
await m.exec('DELETE FROM settlements');
await m.exec('DELETE FROM customs_clearances');
await m.exec('DELETE FROM logistics');
await m.exec('DELETE FROM payments');
await m.exec('DELETE FROM inventory');
await m.exec('DELETE FROM algorithms');
await m.exec('DELETE FROM business_models');
await m.exec('DELETE FROM timeline_events');
await m.exec('DELETE FROM audit_logs');
await m.exec('DELETE FROM applications');
await m.exec('DELETE FROM acceptance_criteria');
await m.exec('DELETE FROM review_workflows');
await m.exec('DELETE FROM trade_stream');
await m.exec('DELETE FROM ports_congestion');
await m.exec('DELETE FROM customs_headers');
await m.exec('DELETE FROM customs_items');
await m.exec('DELETE FROM participant_roles');
await m.exec('DELETE FROM exchange_rates');
await m.exec('DELETE FROM ports');
await m.exec('DELETE FROM countries');
await m.exec('DELETE FROM units');
await m.exec('DELETE FROM carriers');
await m.exec('DELETE FROM incoterms');
await m.exec('DELETE FROM documents');
await m.exec('DELETE FROM track_events');
await m.exec('DELETE FROM enterprises');
await m.exec('DELETE FROM settings');
await m.exec('DELETE FROM algo_test_logs');
await m.exec('DELETE FROM case_traces');
await m.exec('DELETE FROM algorithm_bindings');
await m.exec('DELETE FROM algorithm_flows');

// 若需重新导入期初数据，执行快速重置：
localStorage.removeItem('sqlite_db_v1');
location.reload();
```

> 注意：若浏览器或打包环境禁止直接 `import('/src/lib/sqlite.ts')`，请改用“方法一：快速重置”。

---

## 企业数据 Excel 导入

前端提供企业数据 Excel 导入入口（页面：`参与企业`）。

- 入口位置：`src/pages/Enterprises.tsx`，UI 提供“下载模板”“Excel导入”按钮。
- 模板字段示例（首行）：
  - `id`, `regNo`, `name`, `type`, `category`, `region`, `status`, `compliance`, `service_eligible`, `active_orders`, `last_active`
- 操作步骤：
  1) 点击“下载模板”，按模板填充数据。
  2) 点击“Excel导入”，选择 `.xlsx/.xls` 文件。
  3) 导入成功后页面将提示并刷新列表。
- 后端逻辑：`batchImportEnterprises(data)`（见 `src/lib/sqlite.ts`）在本地库内批量 upsert。

---

## 期初数据说明

期初数据由内置种子生成：
- 订单：约 200 条（企业、品类、金额、币种、状态、时间）
- 通关（申报）：多条示例，包括 `declared/cleared/inspecting/held` 等状态
- 物流：示例运单，节点状态 `pickup/transit/customs/delivery/completed`
- 结算：状态 `pending/processing/completed/failed` 与风险等级
- 支付渠道、库存、算法库、业务模型：若干示例数据与指标
- 企业：≥ 10000 条模拟记录（地区、类型、品类、合规、活跃等）
- 其他：港口/国家/单位、单证、轨迹事件、汇率、算法流程定义等

---

## 注意事项

- 清空与重置为不可逆操作，请先备份（例如读取 `db.export()` 并保存为 Base64）。
- 浏览器 `localStorage` 隔离于域名，切换环境会产生不同的本地库。
- 若后端 API 可用，初始化时会自动同步部分真实数据（订单、申报），其余数据来源于种子。
- 如需对“状态值”进行扩展，请统一前后端枚举并更新前端中文映射逻辑。

---

## 快速索引（开发者）

- 初始化入口：`getDatabase()` → `seed()` → `migrate()` → `syncFromBackendInto()`
- 本地持久化键：`sqlite_db_v1`
- 常用状态中文映射：`src/pages/Capabilities.tsx:94`

