# 项目数据字典与期初数据导入操作手册

本手册包含：

- 现有所有数据表结构（字段、类型、用途）
- 各表涉及的“状态字段”及可选值
- 清空并导入期初数据的两种操作方法（快速重置与精准清空）
- 企业数据 Excel 导入说明

> 当前项目前端内嵌的数据库基于 `sql.js`，使用浏览器 `localStorage` 键 `sqlite_db_v1` 持久化。初始化阶段会执行建表、种子数据填充与必要迁移。

---

## 数据字典

本节以后端 SQLite 数据库 `backend_py/app.db` 为准。以下为由 `backend_py/db.py:init_db()` 创建的实际数据表。字段类型按 SQLAlchemy → SQLite 映射描述。

### orders（订单主表）
- 字段：`id TEXT PRIMARY KEY`, `order_number TEXT`, `enterprise TEXT`, `category TEXT`, `status TEXT`, `amount REAL`, `currency TEXT`, `created_at TEXT`, `updated_at TEXT`
- 说明：`order_number`、`enterprise`、`status` 建有索引
- 常用状态：`pending`、`processing`、`customs`、`shipping`、`completed`、`blocked`
- 格式要求：
  - `status` 仅允许上述枚举；导入时必须小写
  - `currency` 仅允许 `CNY`、`USD`、`EUR`、`GBP`
  - `category` 建议使用：`beauty`、`electronics`、`wine`、`textile`、`appliance`
  - 时间字段使用 ISO 8601（示例：`2025-12-11T08:30:00.000Z`）

### settlements（结算记录）
- 字段：`id TEXT PRIMARY KEY`, `order_id TEXT`, `status TEXT`, `settlement_time INTEGER`, `risk_level TEXT`
- 说明：`order_id`、`status` 建有索引；`risk_level` 默认 `low`
- 常用状态：`pending`、`processing`、`completed`、`failed`
- 格式要求：
  - `status` 仅允许上述枚举；导入时必须小写
  - `risk_level` 仅允许 `low`、`medium`、`high`
  - `settlement_time` 单位小时，整数或一位小数

### logistics（物流记录）
- 字段：`id TEXT PRIMARY KEY`, `tracking_no TEXT`, `origin TEXT`, `destination TEXT`, `status TEXT`, `estimated_time INTEGER`, `actual_time INTEGER`, `efficiency INTEGER`, `order_id TEXT`
- 说明：`tracking_no`、`status`、`order_id` 建有索引
- 常用状态：`pickup`、`transit`、`customs`、`completed`
- 格式要求：
  - `status` 仅允许上述枚举；导入时必须小写
  - `origin`、`destination` 建议使用标准城市名（示例：`上海`、`深圳`）
  - `estimated_time`、`actual_time` 单位小时，整数
  - `efficiency` 为百分比，取值 `0-100`
- 特殊约定：若业务状态为“已签收”，请录入为 `completed`（不使用 `delivery`/派送中）

### inventory（库存指标）
- 字段：`name TEXT PRIMARY KEY`, `current INTEGER`, `target INTEGER`, `production INTEGER`, `sales INTEGER`, `efficiency INTEGER`

### algorithms（算法库）
- 字段：`id TEXT PRIMARY KEY`, `name TEXT`, `category TEXT`, `version TEXT`, `status TEXT`, `accuracy REAL`, `performance REAL`, `usage INTEGER`, `description TEXT`, `features TEXT`, `last_updated TEXT`, `author TEXT`, `code TEXT`
- 格式要求：
  - `accuracy`、`performance` 范围 `0-100`，建议保留一位小数（示例：`94.2`），不可使用 `0-1` 小数
  - `usage` 为非负整数（调用次数）
  - `category` 建议枚举：`optimization`、`coordination`、`inventory`、`control`、`decision`
  - `status` 枚举：`active`、`testing`、`development`
  - `features` 为 JSON 数组字符串（示例：`["实时调度","多目标优化"]`）
  - `last_updated` 为 ISO 8601 时间（示例：`2025-12-11T08:30:00.000Z`）

### business_models（业务模型库）
- 字段：`id TEXT PRIMARY KEY`, `name TEXT`, `category TEXT`, `version TEXT`, `status TEXT`, `enterprises INTEGER`, `orders INTEGER`, `description TEXT`, `scenarios TEXT`, `compliance TEXT`, `chapters TEXT`, `success_rate REAL`, `last_updated TEXT`, `maintainer TEXT`
- 格式要求：
  - `enterprises`、`orders` 为非负整数
  - `success_rate` 范围 `0-100`，建议一位小数
  - `scenarios`、`compliance` 为 JSON 文本（对象/数组）；`chapters` 为 JSON 数组（示例：`["33","84","85"]`）
  - `status` 枚举同算法库；`last_updated` 为 ISO 8601 时间

### jobs（任务队列）
- 字段：`id TEXT PRIMARY KEY`, `type TEXT`, `payload TEXT`, `status TEXT`, `created_at TEXT`, `updated_at TEXT`
- 说明：`status` 默认 `pending`

### users（用户）
- 字段：`id TEXT PRIMARY KEY`, `username TEXT`, `password_hash TEXT`, `email TEXT`, `name TEXT`, `is_active INTEGER`, `created_at TEXT`, `updated_at TEXT`
- 说明：`username`、`email` 唯一且建有索引；`is_active` 为布尔

### roles（角色）
- 字段：`id TEXT PRIMARY KEY`, `name TEXT`, `description TEXT`, `permissions TEXT`, `created_at TEXT`, `updated_at TEXT`
- 说明：`name` 唯一且建有索引

### user_roles（用户角色关联，联结表）
- 字段：`user_id TEXT`, `role_id TEXT`, `PRIMARY KEY(user_id, role_id)`

### model_metrics（模型指标）
- 字段：`id INTEGER PRIMARY KEY AUTOINCREMENT`, `model_id TEXT`, `metric_type TEXT`, `value REAL`, `timestamp TEXT`
- 说明：`model_id` 建有索引

### model_execution_logs（模型执行日志）
- 字段：`id TEXT PRIMARY KEY`, `model_id TEXT`, `model_name TEXT`, `input_snapshot TEXT`, `output_result TEXT`, `business_outcome TEXT`, `business_impact_value REAL`, `latency_ms INTEGER`, `status TEXT`, `timestamp TEXT`

### customs_headers（申报单头表）
- 字段：`id TEXT PRIMARY KEY`, `declaration_no TEXT`, `enterprise TEXT`, `consignor TEXT`, `consignee TEXT`, `port_code TEXT`, `trade_mode TEXT`, `currency TEXT`, `total_value REAL`, `gross_weight REAL`, `net_weight REAL`, `packages INTEGER`, `country_origin TEXT`, `country_dest TEXT`, `status TEXT`, `declare_date TEXT`, `order_id TEXT`, `updated_at TEXT`
- 说明：`declaration_no` 建有索引
- 常用状态：`declared`、`cleared`、`held`、`inspecting`
- 格式要求：
  - `status` 仅允许上述枚举；导入时必须小写
  - `currency` 同 `orders.currency` 要求
  - `declare_date` 使用 `YYYY-MM-DD`
  - `total_value`、`gross_weight`、`net_weight` 为数值，单位按业务规范

### customs_items（申报单货项表）
- 字段：`id TEXT PRIMARY KEY`, `header_id TEXT`, `line_no INTEGER`, `hs_code TEXT`, `name TEXT`, `spec TEXT`, `unit TEXT`, `qty REAL`, `unit_price REAL`, `amount REAL`, `origin_country TEXT`, `tax_rate REAL`, `tariff REAL`, `excise REAL`, `vat REAL`
- 说明：`header_id` 外键指向 `customs_headers.id` 并建索引；`hs_code` 建有索引
- 格式要求：
  - `hs_code` 必须为 8 位或以上（可含点，如 `3304.99.00`）
  - `unit` 使用法定计量单位代码（示例：`KG`、`PCS`）
  - 数值字段允许一位小数；`qty`、`unit_price`、`amount` 为非负

> 注：前端 `sql.js` 中的辅助表（如 `countries`、`units`、`ports` 等）为浏览器侧使用，不属于后端 `app.db` 的权威数据结构，若需保留请另行维护前端数据字典。

---

## 状态字段中文对照

为统一展示，前端使用如下中文映射（示例）：

- `pending` → 等待中
- `in_progress` / `processing` → 进行中
- `completed` → 已完成
- `rejected` / `failed` → 已拒绝
- `declared` → 已申报
- `cleared` → 已通关
- `held` / `inspecting` → 查验中
- `customs` → 报关中
- `pickup` → 揽收
- `transit` → 运输中
- `delivery` → 派送中
- 案例业务结果：
  - 包含 `auto-pass/cleared/release` → 放行
  - 包含 `manual-review/risk/review/flag` → 风险复核
  - 包含 `blocked/reject/failed` → 阻断
  - 包含 `error` → 错误

---

## 清空并导入期初数据

### 方法一：快速重置（推荐）
此方法会清空浏览器持久化的本地数据库，并在刷新后自动执行建表与种子数据导入。

1) 打开浏览器控制台（DevTools），在 `Console` 执行：

```js
localStorage.removeItem('sqlite_db_v1');
location.reload();
```

2) 页面刷新后，前端会自动：
- 创建所有表结构（含迁移）
- 通过内置 `seed()` 写入期初种子数据（订单、申报、物流、结算、支付、库存、算法、业务模型、企业等）
- 执行 `syncFromBackendInto`（如后端可用）同步部分真实数据（订单、申报）

### 方法二：精准清空（保留结构）
此方法仅删除各表数据，不影响表结构。随后可继续执行“快速重置”导入期初数据，或通过各自导入通道导入业务数据。

在控制台执行（示例）：

```js
// 动态导入前端数据库工具
const m = await import('/src/lib/sqlite.ts');

// 逐表清空（仅示例，按需增减）
await m.exec('DELETE FROM orders');
await m.exec('DELETE FROM settlements');
await m.exec('DELETE FROM customs_clearances');
await m.exec('DELETE FROM logistics');
await m.exec('DELETE FROM payments');
await m.exec('DELETE FROM inventory');
await m.exec('DELETE FROM algorithms');
await m.exec('DELETE FROM business_models');
await m.exec('DELETE FROM timeline_events');
await m.exec('DELETE FROM audit_logs');
await m.exec('DELETE FROM applications');
await m.exec('DELETE FROM acceptance_criteria');
await m.exec('DELETE FROM review_workflows');
await m.exec('DELETE FROM trade_stream');
await m.exec('DELETE FROM ports_congestion');
await m.exec('DELETE FROM customs_headers');
await m.exec('DELETE FROM customs_items');
await m.exec('DELETE FROM participant_roles');
await m.exec('DELETE FROM exchange_rates');
await m.exec('DELETE FROM ports');
await m.exec('DELETE FROM countries');
await m.exec('DELETE FROM units');
await m.exec('DELETE FROM carriers');
await m.exec('DELETE FROM incoterms');
await m.exec('DELETE FROM documents');
await m.exec('DELETE FROM track_events');
await m.exec('DELETE FROM enterprises');
await m.exec('DELETE FROM settings');
await m.exec('DELETE FROM algo_test_logs');
await m.exec('DELETE FROM case_traces');
await m.exec('DELETE FROM algorithm_bindings');
await m.exec('DELETE FROM algorithm_flows');

// 若需重新导入期初数据，执行快速重置：
localStorage.removeItem('sqlite_db_v1');
location.reload();
```

> 注意：若浏览器或打包环境禁止直接 `import('/src/lib/sqlite.ts')`，请改用“方法一：快速重置”。

---

## 企业数据 Excel 导入

前端提供企业数据 Excel 导入入口（页面：`参与企业`）。

- 入口位置：`src/pages/Enterprises.tsx`，UI 提供“下载模板”“Excel导入”按钮。
- 模板字段示例（首行）：
  - `id`, `regNo`, `name`, `type`, `category`, `region`, `status`, `compliance`, `service_eligible`, `active_orders`, `last_active`
- 操作步骤：
  1) 点击“下载模板”，按模板填充数据。
  2) 点击“Excel导入”，选择 `.xlsx/.xls` 文件。
  3) 导入成功后页面将提示并刷新列表。
- 后端逻辑：`batchImportEnterprises(data)`（见 `src/lib/sqlite.ts`）在本地库内批量 upsert。

---

## 期初数据说明

期初数据由内置种子生成：
- 订单：约 200 条（企业、品类、金额、币种、状态、时间）
- 通关（申报）：多条示例，包括 `declared/cleared/inspecting/held` 等状态
- 物流：示例运单，节点状态 `pickup/transit/customs/delivery/completed`
- 结算：状态 `pending/processing/completed/failed` 与风险等级
- 支付渠道、库存、算法库、业务模型：若干示例数据与指标
- 企业：≥ 10000 条模拟记录（地区、类型、品类、合规、活跃等）
- 其他：港口/国家/单位、单证、轨迹事件、汇率、算法流程定义等

---

## 注意事项

- 清空与重置为不可逆操作，请先备份（例如读取 `db.export()` 并保存为 Base64）。
- 浏览器 `localStorage` 隔离于域名，切换环境会产生不同的本地库。
- 若后端 API 可用，初始化时会自动同步部分真实数据（订单、申报），其余数据来源于种子。
- 如需对“状态值”进行扩展，请统一前后端枚举并更新前端中文映射逻辑。

---

## 快速索引（开发者）

- 初始化入口：`getDatabase()` → `seed()` → `migrate()` → `syncFromBackendInto()`
- 本地持久化键：`sqlite_db_v1`
- 常用状态中文映射：`src/pages/Capabilities.tsx:94`
### enterprises（参与企业）
- 字段：`id TEXT PRIMARY KEY`, `reg_no TEXT`, `name TEXT`, `type TEXT`, `category TEXT`, `region TEXT`, `status TEXT`, `compliance REAL`, `service_eligible INTEGER`, `active_orders INTEGER`, `last_active TEXT`
- 格式要求：
  - `type` 枚举：`importer`、`exporter`、`both`
  - `category` 建议枚举：`beauty`、`wine`、`appliance`、`electronics`、`textile`
  - `status` 枚举：`active`、`inactive`、`blocked`
  - `compliance` 范围 `0-100`（建议一位小数）；`service_eligible` 为 `0/1`
  - `active_orders` 非负整数；`last_active` 为 ISO 8601 时间
